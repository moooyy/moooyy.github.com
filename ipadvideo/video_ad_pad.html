<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0"/>
        <title> 视频前插片测试 </title>
        <script type="text/javascript">
_sinaadsCacheData = {
    'head1' : {
        "type":"frontfilm",
        "content":[
            {
                "monitor":[
                    "http://sax.sina.com.cn/click?type=3&t=MjAxMy0xMS0yOCAxNzo0MToyNQk2MS4xMzUuM…A1ZmE1ZDkJOGIxMTRlZWI5MWNmZGViMAkJNjlkYTNhZTU1ZjUwCUFFCTIyMzE0NDA5NTUJLQkt"
                ],
                "link":[],
                "type":["xml"],
                "pv":[""],
                "pid":null,
                "src":[
                    'ipad2.mp4'
                ]
            }
        ],
        "size":"300*150",
        "id":"head1"
    },
    'head2' : {
        "type":"frontfilm",
        "content":[
            {
                "monitor":[
                    "http://sax.sina.com.cn/click?type=3&t=MjAxMy0xMS0yOCAxNzo0MToyNQk2MS4xMzUuM…A1ZmE1ZDkJOGIxMTRlZWI5MWNmZGViMAkJNjlkYTNhZTU1ZjUwCUFFCTIyMzE0NDA5NTUJLQkt"
                ],
                "link":[],
                "type":["xml"],
                "pv":[""],
                "pid":null,
                "src":[
                    'ipad2.mp4'
                ]
            }
        ],
        "size":"300*150",
        "id":"head2"
    },
    'head3' : {
        "type":"frontfilm",
        "content":[
            {
                "monitor":[
                    "http://sax.sina.com.cn/click?type=3&t=MjAxMy0xMS0yOCAxNzo0MToyNQk2MS4xMzUuM…A1ZmE1ZDkJOGIxMTRlZWI5MWNmZGViMAkJNjlkYTNhZTU1ZjUwCUFFCTIyMzE0NDA5NTUJLQkt"
                ],
                "link":[],
                "type":["xml"],
                "pv":[""],
                "pid":null,
                "src":[
                    'ipad2.mp4'
                ]
            }
        ],
        "size":"300*150",
        "id":"head3"
    },
    'TEST000000000002' : {
        "type":"pausefilm",
        "content":[
            {
                "monitor":[
                    "http://sax.sina.com.cn/click?type=3&t=MjAxMy0xMS0yOCAxNzo0MToyNQk2MS4xMzUuM…A1ZmE1ZDkJOGIxMTRlZWI5MWNmZGViMAkJNjlkYTNhZTU1ZjUwCUFFCTIyMzE0NDA5NTUJLQkt"
                ],
                "link":[],
                "type":["image"],
                "pv":[""],
                "pid":null,
                "src":[
                    'http://i0.sinaimg.cn/fashion/deco/2013/0623/images/555.jpg'
                ]
            }
        ],
        "size":"300*200",
        "id":"TEST000000000002"
    }
};
        </script>
    </head>
    <body>
        <div id="p_player" style="position:relative;width:600px;height:360px;margin:0 auto;">
            <video id="video" style="background:#000;" src="googleplex.mp4" width="600" height="360" controls>
                <source>无法播放</source>
            </video>
        </div>
        <script charset="utf-8" src="sinaads.full.js"></script>
        <script>
            //定义ipad广告初始化方法;
            var ipad_video_ad = {
                holderId: "p_player", // 外围id
                originalVideoId: "video", // 视频id
                originalVideoElement: "", // 视频DOM
                originalVideo: "", // 视频原片素材
                headArray: [], // 前插片素材堆栈
                pauseArray: [], // 暂停素材堆栈
                headconnect: 0, // 加载完成前插片数量, 成功/失败 都记
                maxhead: 1, // 最大前插片数量
                headTime: 15, // 前插片播放时长
                overtime: 10, //等待超时时长
                playlist: 0, // 当前播放序列
                countcomplete: 0, //倒计时结束
                domcomplete: 0, //容器加载完成
                headcomplete: 0, //前插片加载完成
                isFirstPlay: true, // 是否首次播放标志位
                waitUntil: function (condition, overtime, succ, fail) { // 等待方法 [条件,超时,成功,失败]
                    var start = +new Date();
                    ipad_video_ad.showLoading(true);
                    var wait = setInterval(function () {
                        var nowtime = +new Date();
                        if(condition){
                            ipad_video_ad.showLoading(false);
                            try{succ();}catch(e){}
                            clearTimeout(wait);
                        }else if(nowtime - start >= overtime*1000){
                            ipad_video_ad.showLoading(false);
                            try{fail();}catch(e){}
                            clearTimeout(wait);
                        }
                    } , 100);
                },
                showLoading: function (y) {
                    if(y){
                        var loading = document.getElementById("loading") || document.createElement("div");
                        loading.id = "loading"; 
                        loading.style.cssText = "position:absolute;top:50%;left:50%;width:100px;height:100px;background:url(loading.gif) no-repeat;margin:-50px;display:block;"
                        document.getElementById(ipad_video_ad.holderId).appendChild(loading);
                    }else{
                        document.getElementById("loading").style.display = "none";
                    }
                },
                countdown: function (settime) { // 倒计时
                    var count = document.getElementById("countdown"),
                        totalTime = settime * (ipad_video_ad.headArray.length - ipad_video_ad.playlist),
                        oneTime = settime;
                    
                    if(!count){
                        count = document.createElement("div");
                        count.id = "countdown"; 
                        count.style.cssText = "position:absolute;top:0;right:0;width:300px;height:25px;font:12px/25px Verdana,'宋体';text-align:center;background:rgba(255,255,255,.4);text-shadow:#333 1px 1px 3px;color:#333;"
                        document.getElementById(ipad_video_ad.holderId).appendChild(count);
                    }
                    count.innerHTML = '点击下方广告 了解更多信息, 广告时间还剩 <span id="countNum">'+ totalTime +'</span> 秒';
                    document.getElementById("countNum").style.cssText = "color:#ee0;";
                    ipad_video_ad.showLoading(true);
                    sinaadToolkit.event.on(ipad_video_ad.originalVideoElement, "canplay", function(){ //缓冲完成再开始计时
                        //alert("canplay");
                        ipad_video_ad.showLoading(false);
                        ipad_video_ad.countcomplete = setInterval(function () {
                            if(totalTime === 1){
                                count.parentNode.removeChild(count);
                            }else{
                                document.getElementById("countNum").innerHTML = --totalTime;    
                            }
                            if(oneTime === 1){
                                clearInterval(ipad_video_ad.countcomplete);
                                oneTime = settime;
                                ipad_video_ad.playOne();
                            }else{
                                oneTime--;
                            }
                        }, 1000);
                    });
                },
                playOne: function () { // 播放视频前插
                    ipad_video_ad.originalVideoElement.pause();
                    sinaadToolkit.event.un(ipad_video_ad.originalVideoElement, 'play', ipad_video_ad.onPlay);
                    sinaadToolkit.event.un(ipad_video_ad.originalVideoElement, 'ended', ipad_video_ad.onEnd);
                    ipad_video_ad.originalVideoElement.controls = false;
                    ipad_video_ad.originalVideoElement.setAttribute("webkit-playsinline", true);
                    if (ipad_video_ad.headArray[ipad_video_ad.playlist]){
                        ipad_video_ad.countdown(ipad_video_ad.headTime);
                        ipad_video_ad.originalVideoElement.src = ipad_video_ad.headArray[ipad_video_ad.playlist].src[0];
                        ipad_video_ad.originalVideoElement.play();
                        ipad_video_ad.playlist++;
                    }else{
                        ipad_video_ad.playOriVideo();
                    }
                    ipad_video_ad.isFirstPlay = false;
                },
                playOriVideo: function () { //播放视频正片
                    ipad_video_ad.playlist = "Original";
                    sinaadToolkit.event.un(ipad_video_ad.originalVideoElement, 'play', ipad_video_ad.onPlay);
                    ipad_video_ad.originalVideoElement.controls = true;
                    ipad_video_ad.originalVideoElement.src = ipad_video_ad.originalVideo;
                    ipad_video_ad.originalVideoElement.play();
                    sinaadToolkit.event.on(ipad_video_ad.originalVideoElement, 'pause', ipad_video_ad.onPause);
                },
                onPlay: function () { // 视频播放事件
                    ipad_video_ad.originalVideoElement.pause();
                    if (ipad_video_ad.isFirstPlay) { // 播放前插
                        new ipad_video_ad.waitUntil(ipad_video_ad.headsuccess, 10, ipad_video_ad.playOne, ipad_video_ad.playOriVideo);
                    } else if (ipad_video_ad.playlist === "Pause") { //继续播放
                        alert(ipad_video_ad.playlist);
                        ipad_video_ad.originalVideo.play();
                        ipad_video_ad.playlist = "Original";
                        alert(ipad_video_ad.playlist);
                    } else {// 播放正片
                        ipad_video_ad.playOriVideo();
                    };
                }, 
                onEnd: function () { // 视频播放结束事件
                    if(typeof ipad_video_ad.playlist === "number"){ // 前插结束播放下一条前插或正片
                        ipad_video_ad.playOne();    
                    }else{ // 正片结束初始化所有值
                        ipad_video_ad.init();
                    }
                },
                onPause: function () { // 视频暂停事件
                    sinaadToolkit.event.un(ipad_video_ad.originalVideoElement, 'pause', ipad_video_ad.onPause);
                    ipad_video_ad.playlist = "Pause";
                },
                initHead: function () { // 初始化前插片
                    if(ipad_video_ad.headconnect === ipad_video_ad.maxhead){
                        ipad_video_ad.headsuccess = 1;
                        clearInterval(ipad_video_ad.headcomplete);
                        sinaadToolkit.array.each(ipad_video_ad.headArray, function(item, i) {
                            // console.log(item.src[0]);
                            // ipad_video_ad.preload(item.src[0]);
                        })
                    };
                },
                preload: function (src) { // 预加载资源
                    if(src){
                        var pre = document.createElement("iframe");
                        pre.src = src;
                        document.body.appendChild(pre);
                    }
                },
                initVideoElement: function () { // 初始化视频容器
                    if(document.getElementById(ipad_video_ad.originalVideoId)){
                        clearInterval(ipad_video_ad.domcomplete);
                        ipad_video_ad.originalVideoElement = document.getElementById(ipad_video_ad.originalVideoId);
                        ipad_video_ad.originalVideo = ipad_video_ad.originalVideoElement.src;
                        sinaadToolkit.event.un(ipad_video_ad.originalVideoElement, 'ended', ipad_video_ad.onEnd);
                        sinaadToolkit.event.un(ipad_video_ad.originalVideoElement, 'play', ipad_video_ad.onPlay);
                        sinaadToolkit.event.un(ipad_video_ad.originalVideoElement, 'pause', ipad_video_ad.onPause);
                        sinaadToolkit.event.on(ipad_video_ad.originalVideoElement, 'play', ipad_video_ad.onPlay);
                    }
                },
                init: function () { //初始化接口
                    ipad_video_ad.isFirstPlay = true;
                    ipad_video_ad.playlist = 0;
                    ipad_video_ad.headcomplete = setInterval(ipad_video_ad.initHead, 50);
                    ipad_video_ad.domcomplete = setInterval(ipad_video_ad.initVideoElement, 50);
                }
            };

            //sinaads解析ipad视频广告的方法注册
            sinaadsRenderHandler.frontfilm = function (element, w, h, data, config) {
                //塞入广告素材;
                ipad_video_ad.headArray.push(data[0]);
            }
            sinaadsRenderHandler.pausefilm = function (element, w, h, data, config) {
                var pauseFilm = null;
            }
            ipad_video_ad.init();
        </script>

        <ins class="sinaads" data-ad-pdps="head1"></ins>
        <script>
            (sinaads = window.sinaads || []).push({
                params : {
                    sinaads_video_id : 'video',
                    sinaads_success_handler: function () {
                        ipad_video_ad.headconnect++;
                    },
                    sinaads_fail_handler: function () {
                        ipad_video_ad.headconnect++;
                    }
                }
            });
        </script>
        <!-- <ins class="sinaads" data-ad-pdps="head2"></ins> -->
        <script>
            // (sinaads = window.sinaads || []).push({
            //     params : {
            //         sinaads_video_id : 'video',
            //         sinaads_success_handler: function () {
            //             ipad_video_ad.headconnect++;
            //         },
            //         sinaads_fail_handler: function () {
            //             ipad_video_ad.headconnect++;
            //         }
            //     }
            // });
        </script>
        <!-- <ins class="sinaads" data-ad-pdps="head3"></ins> -->
        <script>
            // (sinaads = window.sinaads || []).push({
            //     params : {
            //         sinaads_video_id : 'video',
            //         sinaads_success_handler: function () {
            //             ipad_video_ad.headconnect++;
            //         },
            //         sinaads_fail_handler: function () {
            //             ipad_video_ad.headconnect++;
            //         }
            //     }
            // });
        </script>
        
        <ins class="sinaads" data-ad-pdps="TEST000000000002"></ins>
        <script>
            (sinaads = window.sinaads || []).push({
                params : {
                    sinaads_video_id : 'video'
                }
            });
        </script>
    </body>
</html>